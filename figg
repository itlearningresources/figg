#!/usr/bin/ksh
Tmp="/tmp/$$"
TmpDir="/tmp/dir$$"
trap 'rm -f "$Tmp" >/dev/null 2>&1' 0
trap "exit 2" 1 2 3 13 15

CPATH=classes
CPATH=$CPATH:lib/joda-time-2.8.1.jar
CPATH=$CPATH:lib/commons-logging-1.1.3.jar 
CPATH=classes
JAVAPATH=java 
JAVAPATH=/home/mestes/jdk-11.0.2/bin/java 
JAVACPATH=javac 
JAVACPATH=/home/mestes/jdk-11.0.2/bin/javac 
XLINTS="-Xlint:-deprecation -Xlint:-rawtypes"
RUNHWIDTH=`gawk -v w=RUNHWIDTH -v v=88 -F= '{gsub(/[;].*$/,"",$0);gsub(/[ ]*$/,"",$0);if ($1==w) {v=$2;exit;}}END{print v}' .figg`
QFIXWIDTH=`gawk -v w=QFIXWIDTH -v v=12 -F= '{gsub(/[;].*$/,"",$0);gsub(/[ ]*$/,"",$0);if ($1==w) {v=$2;exit;}}END{print v}' .figg`
help() {
                          print "\n"
                          print "  (f)ile (e)dit (n)ew (b)lank (c)ompile (d)ebug (r)un (l)ist (j)avadoc (h)elp" 
                          print "\n"
                          print "          f <source file name>      - Change the current source file" 
                          print "          e                         - Edit current source file" 
                          print "          c                         - Compile current source file" 
                          print "          d                         - Edit source file and listing file" 
                          print "          r                         - Run (no split window)" 
                          print "          R                         - Run in split window" 
                          print "          l                         - list source file to screen" 
                          print "          j                         - Generate and display Javadoc" 
                          print "          n                         - New source file using template" 
                          print "          b                         - New blank source file" 
                          print "\n"
                          print "          q                         - Quit" 
                          print "          h                         - Help" 
                          print "\n"
                          print "\n"

                          print "Current source file is "$JF"\n" 
                          print "Current command line classpath is" 
                          print $CPATH
                          print "" 
                          javac -version
                          java -version
                          print "$JAVACPATH $XLINTS -cp $CPATH -d classes src/$JF.java 2> tmp/$JF.lst" >&2
                          print "$JAVAPATH/java -cp $CPATH -ea $1 $2 $3 $4 $5 $6 $7" >&2
                          print "\n" 
}
run() {
               print "$JAVAPATH/java -cp $CPATH -ea $1 $2 $3 $4 $5 $6 $7" >&2
               $JAVAPATH -cp $CPATH -ea $1 $2 $3 $4 $5 $6 $7
}
compile() {
               JF=$1
               rm -f tmp/$JF.lst >/dev/null 2>&1
               print "$JAVACPATH $XLINTS -cp $CPATH -d classes src/$JF.java 2> tmp/$JF.lst" >&2
               $JAVACPATH $XLINTS -cp $CPATH -d classes src/$JF.java 2> tmp/$JF.lst
}
compileDebug() {
               JF=$1
               compile $JF
               if [[ $? -ne 0 ]]; then
                         print "Listing"
                         cp tmp/$JF.lst last.lst 
                         # vi src/$JF.java tmp/$JF.lst
                         # vim quickfix stuff
                         # :copen " Open the quickfix window
                         # :ccl   " Close it
                         # :cw    " Open it if there are "errors", close it otherwise (some people prefer this)
                         # :cn    " Go to the next error in the window
                         # :cnf   " Go to the first error in the next file
                         vim -c "cw" -c "resize $QFIXWIDTH" -c "map <F1> :cn<cr><cr>" -c "map <F2> :cp<cr><cr>" -q tmp/$JF.lst
               else
                    print "Compile OK" >&2
               fi
}
Interactive() {
                while [[ "$cmd" != "q" ]]
                do
                     print -n "figg/$JF >> ";read var;set -A arr $var;
                     cmd=${arr[0]};
	             case $cmd  in
                       x) cmd="q" ;;
                       f) JF=${arr[1]} ;;
                       s) cat src/$JF.java ;;
                       v) vim ~/.vimrc ;;
                       ff) vim figg ;;

                       n) JF=${arr[1]}
                          figg -n $JF ;;
                       b) JF=${arr[1]}
                          figg -b $JF ;;
                       e) figg -e $JF ;;
                       a) figg -a $JF ;;
                       c) figg -c $JF ;;
                       t) figg -t $JF ;;
                       d) figg -d $JF ;;
                       j) figg -j $JF ;;
                       r) figg -r $JF $1 $2 $3 $4 $5 $6;;
                       R) figg -R $JF $1 $2 $3 $4 $5 $6;;
                       y) figg -y ;;
                       l) figg -l ;;
                       ls) figg -l ;;
                       reset)
                           rm -f classes/*.class  >/dev/null 2>&1
                           ;;
                       h) help
                          ;;
                       *) if [ -s src/$cmd.java ]
                          then
                               vim src/$cmd.java 
                          fi
                          ;;
	             esac
                done
}
while getopts "b:t:n:d:c:r:R:a:e:i:lxvj" arg
do
	case $arg in
            i)  
                JF=$OPTARG 
                JF=`echo $OPTARG | gawk '{gsub(/[.]java$/,"",$0);print $0;}'`
                if [ ! -e "src/$JF.java" ]; then
                    print "Error: src/$JF.java does not exist"
                    exit 1
                fi

                shift $(($OPTIND - 1))
                Interactive

               ;;
            c) compileDebug $OPTARG 
               ;;
            n) JF=`echo $OPTARG | gawk '{gsub(/[.]java$/,"",$0);print $0;}'`
               shift $(($OPTIND - 1))
               if [ ! -e "src/$JF.java" ]; then
                    cat src/Template.txt | gawk -v v=$JF '{sub("NNAME",v,$0);print $0;}' > $Tmp
                    cp $Tmp src/$JF.java
                    vim src/$JF.java
               else
                    print "Error: src/$JF.java already exists"
               fi
               ;;
            b) JF=`echo $OPTARG | gawk '{gsub(/[.]java$/,"",$0);print $0;}'`
               shift $(($OPTIND - 1))
               if [ ! -e "src/$JF.java" ]; then
                    touch $Tmp src/$JF.java
                    vim src/$JF.java
               else
                    print "Error: src/$JF.java already exists"
               fi
               ;;
            d) JF=$OPTARG 
               shift $(($OPTIND - 1))
               vim -o tmp/$JF.lst src/$JF.java
               ;;
            y) 
               print "Compile All"
               for file in src/*.java; do
                   JF=`echo $file | gawk '{gsub(/[.]java$/,"",$0);gsub(/^src[/]/,"",$0);print $0;}'`
                   print $JF
                   compile $JF
                done 
               ;;
            R) JF=$OPTARG 
               shift $(($OPTIND - 1))
               rm -f $Tmp >/dev/null 2>&1
               run -ea $JF $1 $2 $3 $4 $5 $6 | tee $Tmp
               vim -c "wincmd w | vert resize $RUNHWIDTH | wincmd w" -O src/$JF.java $Tmp
               ;;
            r) JF=$OPTARG 
               shift $(($OPTIND - 1))
               run $JF $1 $2 $3 $4 $5 $6
               ;;
            a) JF=$OPTARG 
               shift $(($OPTIND - 1))
               compile $JF
               #run $JF $1 $2 $3 $4 $5 $6
               ;;
            e) JF=$OPTARG 
               vim src/$JF.java
               ;;
            l) ls src
               ;;
            j) javadoc -d doc src/*.java
               xdg-open  "doc/index.html" >/dev/null 2>&1
               ;;
            v) java  -version
               ;;
	    *) exit 0 ;;
	esac
done


